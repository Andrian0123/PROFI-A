# Отчёт по задачам проекта PROFI-A

## Что выполнено

### 1. Экран комнаты (AddRoomScreen) — виды работ
- **Иконка «Редактировать» вместо «Удалить»:** у каждой позиции в списке видов работ (Потолок, Стены, Пол и т.д.) стоит иконка карандаша; по нажатию данные подставляются в форму, кнопка меняется на «Сохранить», сохранение обновляет позицию в списке.
- **Начальная единица измерения «кв.м.»:** по умолчанию в форме видов работ выбраны квадратные метры.
- **Подстановка количества по помещениям:** при раскрытии секции «Потолок» в кол-во подставляется площадь потолка, «Стены» — площадь стен, «Пол» — площадь пола (из блока «Расчёты»). После добавления/сохранения позиции в этих секциях снова подставляются «кв.м.» и соответствующая площадь.

### 2. Общая смета (GeneralEstimateScreen)
- **Разбивка по помещениям:** смета выводится по порядку создания помещений; у каждого помещения — заголовок, список позиций, итог по помещению, затем общая сумма.
- **Кнопка «Поделиться» (справа вверху):** по нажатию выбор формата PDF или Excel (CSV), формирование файла и отправка через системное «Поделиться».
- **Отображение проекта:** вверху показывается название проекта и подпись «Общая предварительная смета помещений по данному проекту».

### 3. Промежуточные сметы (акты)
- **Кнопка «Создать промежуточная смета» (слева вверху на экране сметы):** включение режима выбора.
- **Режим выбора:** у каждой позиции появляется кружок; нажатие переключает выбор, выбранные карточки подсвечиваются. Кнопки «Отмена» и «Создать». При «Создать» выбранные позиции сохраняются как акт с датой/временем в названии.
- **Экран «Акты»:** доступ с экрана проекта по кнопке «Акты»; список сохранённых актов по выбранному проекту.
- **Просмотр акта:** нажатие на карточку акта открывает диалог с содержимым (по помещениям, с итогом).
- **Поделиться актом:** в диалоге просмотра — кнопка «Поделиться»; выбор PDF или Excel, формирование файла и отправка.

### 4. Хранение актов
- Добавлены сущности и БД: `IntermediateEstimateActEntity`, `IntermediateEstimateActItemEntity`, DAO, миграция 3→4, методы в `ProjectRepository` (сохранение и загрузка актов по `projectId`).

### 5. Профиль ИП/ООО — КС-2 и КС-3
- **Блок «КС-2 / КС-3» на экране профиля:** отображается только при типе «ИП / ООО»; кнопка «Сформировать КС-2 / КС-3».
- **Экран формирования:** выбор типа документа (КС-2 или КС-3), выбор проекта, выбор акта, кнопка «Сформировать PDF / Excel» с выбором формата; формирование файла по форме КС-2 или КС-3 (реквизиты из профиля, данные акта) и отправка.

### 6. Экспорт в файлы
- **EstimateExport.kt:** экспорт общей сметы в PDF и CSV; экспорт одного акта в PDF и CSV (по помещениям, с итогами).
- **Ks2Ks3Export.kt:** экспорт КС-2 и КС-3 в PDF и CSV с подстановкой данных профиля и акта.
- **FileProvider:** настроен в манифесте и `res/xml/file_paths.xml` для раздачи сгенерированных файлов при «Поделиться».

### 7. Привязка данных к проекту
- На экране проекта добавлена подпись: «Комнаты, сметы и акты формируются индивидуально по каждому проекту».
- На экранах «Предварительная смета» и «Акты» отображается название проекта и подписи, что данные по данному проекту.

### 8. Интерфейс
- На экране редактирования комнаты меню (гамбургер) не показывается (`onMenuClick = null`).
- Нижняя панель с кнопкой «Калькулятор» не отображается (`bottomBar = { }` в навигации).

---

## Созданные и изменённые файлы

### Новые файлы
| Файл | Назначение |
|------|------------|
| `app/src/main/java/.../ui/export/EstimateExport.kt` | Экспорт сметы и акта в PDF/CSV |
| `app/src/main/java/.../ui/export/ExportUtils.kt` | Утилита экранирования CSV для экспорта |
| `app/src/main/java/.../ui/export/Ks2Ks3Export.kt` | Экспорт КС-2/КС-3 в PDF/CSV |
| `app/src/main/java/.../data/local/entity/IntermediateEstimateActEntity.kt` | Сущность акта |
| `app/src/main/java/.../data/local/entity/IntermediateEstimateActItemEntity.kt` | Позиция акта |
| `app/src/main/java/.../data/local/dao/IntermediateEstimateActDao.kt` | DAO для актов |
| `app/src/main/java/.../ui/screens/ActsScreen.kt` | Экран списка актов |
| `app/src/main/java/.../ui/screens/FormKs2Ks3Screen.kt` | Экран формирования КС-2/КС-3 |
| `app/src/main/java/.../ui/viewmodel/ActsViewModel.kt` | ViewModel экрана актов |
| `app/src/main/java/.../ui/viewmodel/FormKs2Ks3ViewModel.kt` | ViewModel КС-2/КС-3 |
| `app/src/main/res/xml/file_paths.xml` | Пути для FileProvider |

### Изменённые файлы (основные)
| Файл | Изменения |
|------|-----------|
| `AddRoomScreen.kt` | Редактирование позиций (карандаш), кв.м. по умолчанию, подстановка площадей, режим выбора для промежуточной сметы |
| `GeneralEstimateScreen.kt` | Разбивка по помещениям, кнопка «Поделиться», выбор PDF/Excel, кнопка «Создать промежуточная смета», режим выбора, название проекта |
| `GeneralEstimateViewModel.kt` | Секции по помещениям, сохранение акта, название проекта |
| `ProjectDetailScreen.kt` | Переход на «Акты», подпись про комнаты/сметы/акты по проекту |
| `ProjectRepository.kt` | Методы актов, `IntermediateEstimateActDao` в конструкторе |
| `AppDatabase.kt` | Миграция 3→4, новые сущности и DAO |
| `AppModule.kt` | Провайдер `IntermediateEstimateActDao`, миграция 3→4, обновлённый `ProjectRepository` |
| `NavRoutes.kt` | Маршруты `ACTS`, `FORM_KS2_KS3`, функции `acts()`, `form_ks2_ks3` |
| `ProfiANavHost.kt` | Композабли `ActsScreen`, `FormKs2Ks3Screen` |
| `ProfileScreen.kt` | Блок «КС-2 / КС-3» для типа ИП/ООО |
| `AndroidManifest.xml` | Провайдер FileProvider |

---

## Что осталось / что можно сделать дальше

### Текущий статус
По **ОТЧЁТ_НЕВЫПОЛНЕННЫХ_ЗАДАЧ.md** на данный момент невыполненных задач **нет**: все пункты из списка пользователя и рекомендаций отмечены как выполненные или уточнённые.

### Опциональные доработки (по желанию)
- **Предупреждения сборки (по умолчанию):** предупреждения (kapt, 16 KB alignment и т.д.) не блокируют сборку; при необходимости — обновить нативные библиотеки или AGP по документации Android.
- **Тесты:** добавлены ExportUtils (CSV), IntermediateEstimateActItemEntity (total, итог по акту), RoomWorkItemEntity (total, итог по комнате). По желанию — репозиторий актов, сценарии экспорта.
- **3D-скан:** база (RoomScan, экран, кнопки «Создать»/«Загрузить») есть; при необходимости — полноценный скан/реконструкция по аналогии с Polycam.
- **Итоговая смета:** выполнено: кнопка «Итоговая смета» на экране проекта, отдельный маршрут и заголовок/подпись; данные пока те же, что у предварительной сметы. При необходимости — отдельная логика (например, по актам).

---

*Отчёт обновлён по состоянию проекта. Детали — в ОТЧЁТ_ВЫПОЛНЕННЫХ_ЗАДАЧ.md и ОТЧЁТ_НЕВЫПОЛНЕННЫХ_ЗАДАЧ.md. Перечисленные созданные файлы проверены — недостающих нет.*

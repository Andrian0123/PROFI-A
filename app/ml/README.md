# ML-модуль: путь фото 3D сканер

Обучаемая модель для анализа видео сканера: углы, примыкания, окна/двери, размеры помещения, откосы и короба.

## Логика

- **Анализ видео сканера** — по кадрам строится облако точек, RANSAC выделяет плоскости, находятся углы (junctions).
- **Размеры помещения** — считаются автоматически (высота стен, периметр, площадь пола) и подставляются в размеры комнаты.
- **Дверь/окно** — классифицируются как проёмы; при определении добавляются в раздел **«Откосы»** (reveals) с размерами width_m × height_m × depth_m.
- **Дополнительные углы** — воспринимаются как **короб**; каждая плоскость короба считывается по вертикали; вертикаль учитывается как **погонный метр (м.п.)** и добавляется в раздел **«Короба»** (frame_planes, поле `linear_m`).

## Компоненты

| Файл | Назначение |
|------|------------|
| `features.py` | Извлечение признаков из облака точек и плоскостей (нормаль, размеры, площадь, aspect ratio). |
| `model.py` | Классификатор плоскостей: wall, floor, ceiling, door, window, reveal, frame. Эвристика по умолчанию; при наличии `scikit-learn` — RandomForest. |
| `dataset.py` | Датасет из JSON-аннотаций (`*_planes.json`: `planes[].features`, `planes[].label`). |
| `train.py` | Скрипт обучения: `python -m app.ml.train --data_dir ./data/annotations [--model_dir ./app/ml/models]`. |
| `inference.py` | Вывод: по плоскостям и облаку точек возвращает списки `Reveal` (откосы) и `FramePlane` (короба; вертикаль — погонный метр `linear_m`). |

## Обучение

1. Подготовить аннотации в JSON:
   ```json
   {
     "planes": [
       { "features": [0.1, -0.02, ...], "label": "wall" },
       { "features": [...], "label": "door" }
     ]
   }
   ```
   Признаки можно получить из реальных сканов через `extract_plane_features(point_cloud, planes)` и вручную проставить метки (wall, door, window, reveal, frame и т.д.).

2. Положить файлы вида `*_planes.json` в директорию (например `data/annotations/`).

3. Установить зависимости и запустить обучение:
   ```bash
   pip install scikit-learn joblib
   python -m app.ml.train --data_dir data/annotations --model_dir app/ml/models
   ```

4. Модель сохранится в `app/ml/models/` (classifier.joblib + meta.json). При наличии файлов в этой директории пайплайн может загружать обученную модель (доработка: передать путь в `run_scan_inference(..., model_path=...)`).

Без аннотаций используется встроенная **эвристика** (по нормали, высоте, площади и aspect ratio определяется door/window/reveal/frame).

## Интеграция

- В `scan_processor.py` после вычисления плоскостей и размеров вызывается `run_scan_inference(point_cloud, planes, dimensions)`. Результат (`reveals`, `frame_planes`) попадает в `ScanProcessResponse` и в API ответ.
- Размеры комнаты (`dimensions`) уже автоматически подставляются в форму комнаты на клиенте (периметр и т.д.).
- Откосы и короба приходят в ответе скана; клиент может добавлять их в соответствующие разделы экрана комнаты (откосы/короба). Для короба вертикаль каждой плоскости передаётся как **погонный метр** (`linear_m`, м.п.).

# Анализ проекта PROFI-A: путь, комнаты, функции, задачи

**Дата:** 20.02.2026  
**Цель:** полный обзор структуры проекта, функций (особенно комнат), всех задач, недостающего и возможных улучшений.

---

## 1. Структура проекта (путь)

```
e:\PROFI-A\
├── app/                    # Android (Kotlin, Jetpack Compose)
│   └── src/main/java/ru/profia/app/
│       ├── data/           # модели, Room DAO, репозитории, remote API
│       ├── di/             # Hilt
│       ├── ui/screens/     # экраны (AddRoomScreen, RoomScanScreen, сметы, акты и т.д.)
│       ├── ui/components/  # NavigationDrawer, BaseScreen, диалоги
│       ├── ui/navigation/  # ProfiANavHost, NavRoutes
│       ├── ui/viewmodel/   # AddRoomViewModel, RoomScanViewModel и др.
│       └── ui/export/      # EstimateExport, Ks2Ks3Export
├── server/                 # Node.js reference backend (auth, support; НЕ scan)
│   └── server.js           # порты 3001 (auth), 3002 (support), 3003 (scan proxy)
├── app/                    # Python FastAPI — сервис 3D-сканирования
│   ├── main.py             # FastAPI app, router /api/v1/scan
│   ├── api/endpoints/scan.py
│   ├── core/processing/    # scan_processor, point_cloud, ransac, junctions
│   └── models/schemas.py
├── tests/                  # тесты (scan API, finish API и др.)
├── docs/                   # контракты API, алгоритмы, статусы задач
├── tools/                  # add_missing_i18n.py, check_i18n_parity.py
├── README.md
├── ОТЧЁТ_ВЫПОЛНЕННЫХ_ЗАДАЧ.md
├── ОТЧЁТ_НЕВЫПОЛНЕННЫХ_ЗАДАЧ.md
├── ПРИОРИТИЗИРОВАННЫЙ_ПЛАН_ДОРАБОТОК_2026-02-18.md
└── docs/STATUS_ЗАДАЧ_CANONICAL.md   # канонический источник статуса
```

**Замечание:** В корне есть две папки `app/`: одна — Android-модуль (внутри `app/src/...`), вторая — Python-сервис сканирования. По путям это различается: Android — `app/src/main/java/...`, Python — `app/main.py`, `app/api/...`.

---

## 2. Комнаты: реализованные функции

### 2.1 Модели и БД

- **RoomEntity** — таблица `rooms`: id, projectId, name, length, width, height, floorArea, wallArea, ceilingArea, perimeter, hasSlopes, slopesLength, hasBoxes, boxesLength, createdAt, updatedAt.
- **RoomData** — доменная модель с openings.
- **OpeningEntity / OpeningData** — проёмы (окна/двери): type, width, height, count.
- **RoomWorkItemEntity** — виды работ по комнате (категория, название, ед. изм., цена, количество).
- **RoomScanEntity** — привязка скана к проекту/комнате, meshPath для загруженного 3D-файла.

### 2.2 Экран комнаты (AddRoomScreen)

| Функция | Статус |
|--------|--------|
| Название, длина, ширина, высота | ✅ |
| Расчёты: площадь пола, стен, потолка, периметр (с учётом проёмов) | ✅ |
| Откосы и короба (длина) | ✅ |
| Проёмы (окна/двери): добавление, редактирование, удаление | ✅ |
| Разделы видов работ (Потолок, Стены, Пол, Двери, Окна, Сантехника, Электрика, Вентиляция, Прочие) | ✅ |
| Подстановка площадей (потолок/стены/пол) в виды работ | ✅ |
| Единицы измерения (п.м., кв.м., шт., м³, т.) | ✅ |
| Редактирование позиции (карандаш), сохранение | ✅ |
| Общая сумма по комнате в блоке «Расчёты» | ✅ |
| Калькулятор в шапке (SimpleCalculatorDialog) | ✅ |
| Меню (гамбургер) не показывается на экране комнаты | ✅ |
| Фото 3D: диалог «Создать» / «Загрузить» | ✅ |
| «Загрузить»: выбор файла → копирование в папку приложения, сохранение пути в RoomScan (meshPath) | ✅ |
| Подстановка шаблонов работ по разделам («Из шаблонов») | ✅ |
| Подстановка размеров из 3D-скана: высота стен и периметр через SavedStateHandle после возврата со скана | ✅ (частично: см. ниже) |

### 2.3 Интеграция 3D-скана с комнатой

- **RoomScanScreen** вызывает backend `/process` и при необходимости `/finish`, получает `dimensions` (wall_height_m, perimeter_m, floor_area_m2).
- При нажатии «Сохранить» на экране размеров в SavedStateHandle предыдущего экрана записываются `roomScanWallHeight` и `roomScanPerimeter`.
- **AddRoomScreen** в `LaunchedEffect` читает эти значения: высоту подставляет в поле «Высота», периметр сохраняет в локальное состояние `scanPerimeter` (отображение; не подставляет длину/ширину или площадь пола автоматически).
- **Не используется:** `floor_area_m2` из ответа скана не передаётся в форму комнаты (можно было бы подставлять площадь пола или предлагать длину/ширину).

---

## 3. Все задачи: сводка

Источники: `ОТЧЁТ_ВЫПОЛНЕННЫХ_ЗАДАЧ.md`, `ОТЧЁТ_НЕВЫПОЛНЕННЫХ_ЗАДАЧ.md`, `docs/STATUS_ЗАДАЧ_CANONICAL.md`, `docs/АНАЛИЗ_МЕНЮ_И_ЗАДАЧА.md`.

### 3.1 Выполнено (ядро)

- Комната: виды работ, расчёты, проёмы, откосы/короба, калькулятор, загрузка 3D, подстановка из скана (высота + периметр в UI).
- Сметы: предварительная и итоговая, разбивка по помещениям, «Поделиться» (PDF/CSV), промежуточная смета → акты.
- Акты: список по проекту, просмотр, редактирование позиций, экспорт.
- КС-2/КС-3: блок в профиле для ИП/ООО, формирование PDF/CSV.
- Экспорт: EstimateExport, Ks2Ks3Export, FileProvider, данные заказчика/исполнителя.
- БД: проекты, комнаты, проёмы, виды работ, акты (миграции 3→4, 4→5), RoomScan.
- Шаблоны работ: WorkTemplate (DataStore), WorkCategoryScreen, подстановка в комнату.
- Локализация: RU/EN и др., часть строк в ресурсах.
- Цветовые токены: единый источник в `Color.kt` / `colors.xml`.

### 3.2 Не выполнено или неполно

| Приоритет | Блок | Что не сделано |
|-----------|------|----------------|
| **Критичный** | Авторизация | Реальный login/register API; сейчас один колбэк onAuthComplete (AuthScreen). |
| **Критичный** | Аккаунт | Backend: смена пароля, 2FA, удаление аккаунта; без заглушек (ChangePasswordScreen, ProfileScreen). |
| **Критичный** | 3D-сканирование | E2E: полная интеграция (отметка участков на плане по алгоритму, автоподстановка всех размеров в комнату, в т.ч. floor_area). |
| Средний | Поддержка | Backend endpoint для обращений; сейчас только mailto (SupportScreen). |
| Средний | Виды работ | Вкладки «Общие данные», «Материалы» — реальный контент вместо placeholder (AddWorkTypesScreen). |
| Средний | Этапы | Реальный контент вместо catalog_placeholder (StagesScreen). |
| Средний | Локализация | Вынести оставшиеся hardcoded строки (ProfileScreen, AddRoomScreen, SupportScreen, AboutScreen и др.). |
| Низкий | Документация | Рассинхрон отчётов (canonical — STATUS_ЗАДАЧ_CANONICAL.md). |
| Низкий | UX/доступность | Унификация и локализация contentDescription. |

### 3.3 Расхождение по меню (документ АНАЛИЗ_МЕНЮ_И_ЗАДАЧА)

- В **ОТЧЁТ_ВЫПОЛНЕННЫХ_ЗАДАЧ.md** указано: «Калькулятор в навигации: пункт «Калькулятор» в боковом меню (drawer) — Выполнено».
- По коду: в **NavigationDrawer.kt** пункта «Калькулятор» нет; переход на калькулятор из drawer не реализован.
- **Итог:** пункт «Калькулятор» в drawer и переход из меню — **не выполнены**; доступ к калькулятору — только через иконку в шапке на экране комнаты, создания проекта и видов работ.

---

## 4. Недостающее (кратко)

1. **Auth/Account:** реальный API и привязка Android (login/register, change password, 2FA, delete account). Reference-сервер в `server/server.js` есть, но приложение к нему не подключено единым контуром.
2. **3D-scan E2E:**  
   - экран отметки участков на плане по алгоритму измерения помещения;  
   - передача в комнату не только высоты и периметра, но и площади пола (floor_area_m2);  
   - опционально: длина/ширина, выведенные из периметра и площади.
3. **Support:** backend endpoint для тикетов вместо только mailto.
4. **Контент:** убрать placeholder в «Общие данные» и «Материалы» (AddWorkTypesScreen), реализовать контент StagesScreen.
5. **Локализация:** все оставшиеся строки в strings.xml, синхронизация values*.
6. **Drawer:** добавить пункт «Калькулятор» и переход на CalculatorScreen (или зафиксировать в документации, что доступ только из шапки).
7. **Единый источник статуса:** вести только STATUS_ЗАДАЧ_CANONICAL.md, остальные отчёты обновлять по нему при релизах.

---

## 5. Что можно улучшить или добавить

### 5.1 Комнаты и смета

- **Подстановка floor_area_m2 из скана:** при возврате с RoomScanScreen передавать в SavedStateHandle также площадь пола и в AddRoomScreen подставлять в «Площадь пола» или предлагать длину/ширину (например, из периметра и площади).
- **Валидация размеров:** минимальные/максимальные значения (высота, длина, ширина), предупреждение при нулевой площади.
- **Копирование комнаты:** «Дублировать комнату» в проекте (те же размеры, проёмы, виды работ — с возможностью правки).
- **Сортировка комнат в смете:** по имени, по площади, по сумме (переключатель или настройка).

### 5.2 3D-сканирование

- **Отметка участков на плане:** по документу «Алгоритм измерения помещения 3D» — зоны пола, стен, потолка, проёмов для приоритета анализа.
- **Визуализация ответа backend:** отрисовка `coverage.web_lines` и `missing_zones` на превью/карте (по контракту API_СКАНИРОВАНИЯ_ANDROID_PYTHON.md).
- **Повторная отправка при ошибке:** retry для /process и /finish с понятным сообщением пользователю.
- **Офлайн/кэш:** сохранение последнего результата скана по scan_id для повторного просмотра размеров без повторного запроса.

### 5.3 Навигация и UX

- Добавить в drawer пункт «Калькулятор» с маршрутом на CalculatorScreen (и обработку в ProfiANavHost) — для соответствия отчёту и удобства.
- Унифицировать contentDescription (в т.ч. «Калькулятор» в CreateProjectScreen — заменить хардкод на stringResource).
- Проверка контрастности и TalkBack для ключевых экранов (комната, смета, сканирование).

### 5.4 Backend и качество

- **Python scan:** логирование и метрики времени обработки; лимит размера файлов в конфиге; опциональная очередь задач при высокой нагрузке.
- **Node server:** если используется как референс — явно описать в README, что порт 3003 — proxy к Python scan; контракты в BACKEND_API_CONTRACTS.md соблюдены для auth/support.
- **Тесты:** расширить E2E/интеграционные тесты на сценарии «создать проект → комната → смета → экспорт» и «скан → размеры → комната».

### 5.5 Документация и процесс

- Один раз актуализировать ОТЧЁТ_ВЫПОЛНЕННЫХ_ЗАДАЧ и ОТЧЁТ_НЕВЫПОЛНЕННЫХ_ЗАДАЧ по STATUS_ЗАДАЧ_CANONICAL.md (в т.ч. пункт «Калькулятор в drawer»).
- В README проекта кратко указать: Android app, Node reference backend, Python scan service; как запускать каждый компонент и какие URL задать в BuildConfig.

---

## 6. Итоговая таблица: комнаты и смежные задачи

| Область | Реализовано | Недостающее | Улучшения |
|---------|-------------|-------------|-----------|
| Модель комнаты, БД | RoomEntity, проёмы, виды работ, RoomScan | — | — |
| AddRoomScreen | Размеры, расчёты, проёмы, виды работ, калькулятор, 3D загрузка, подстановка высоты/периметра со скана | — | Подстановка floor_area из скана; валидация; дублирование комнаты |
| RoomScanScreen | Камера, шаги, вызов /process и /finish, передача высоты и периметра в комнату | Отметка участков на плане; полная автоподстановка (в т.ч. площадь пола) | Визуализация coverage/junctions; retry; офлайн-кэш результата |
| Backend scan (Python) | /process, /finish, dimensions, coverage, junctions | — | Логирование, метрики, лимиты |
| Навигация | Калькулятор по маршруту, иконка в шапке на части экранов | Пункт «Калькулятор» в drawer | Добавить пункт в drawer и обработку перехода |
| Auth/Support | Reference server (Node) реализован | Подключение Android к API; production-ready | — |
| Справочники | RoomTypes, Works, частично Materials/Stages | Контент «Общие данные», «Материалы», этапы | Убрать placeholder |

---

*Документ можно использовать как единую точку входа для планирования доработок по комнатам и общим задачам проекта.*

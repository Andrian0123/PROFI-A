# Что можно доработать или добавить

Предложения по развитию модуля 3D-сканера и экрана комнаты.

**Если при сканировании видите «Сервер сканирования недоступен» и значения 12,40 м / 2,75 м** — см. [Как подключить сервер сканирования](КАК_ПОДКЛЮЧИТЬ_СЕРВЕР_СКАНИРОВАНИЯ.md).

---

## 1. Android: откосы и короба из скана

**Сейчас:** API возвращает `reveals` (откосы) и `frame_planes` (короба с `linear_m`), но приложение их не парсит и не показывает.

**Сделать:**
- В `ScanProcessingApi` / `parseDimensionsResponse` добавить разбор `reveals` и `frame_planes` из JSON.
- Расширить `ScanDimensionsResult` (или ввести отдельную модель) полями:
  - `reveals: List<RevealDto>` (opening_type, width_m, height_m, depth_m, confidence)
  - `framePlanes: List<FramePlaneDto>` (width_m, height_m, linear_m, confidence)
- Передавать эти списки в навигацию (например через `savedStateHandle` или аргументы маршрута) в экран добавления/редактирования комнаты.
- В **AddRoomScreen**: при переходе со скана подставлять:
  - **откосы** — как предложенные проёмы (окна/двери) или отдельный блок «Откосы по скану» с возможностью принять/отклонить;
  - **короба** — сумму `linear_m` в поле «Короба» (м.п.) или список граней с погонными метрами.

---

## 2. Документация API: новые поля ответа

**Сейчас:** В `docs/API_СКАНИРОВАНИЯ_ANDROID_PYTHON.md` нет полей `reveals`, `frame_planes`, `linear_m`.

**Сделать:**
- В раздел «Ответ сервера» добавить описание:
  - `reveals[]`: opening_type, width_m, height_m, depth_m, position_3d, confidence;
  - `frame_planes[]`: width_m, height_m, **linear_m** (погонные метры по вертикали), position_3d, plane_index, confidence;
- Кратко пояснить: откосы — раздел «Откосы», короба — раздел «Короба», вертикаль короба = погонный метр.

---

## 3. Бэкенд: настройки без пересборки

**Сейчас:** Доля «потолка» для длины/ширины зашита константой `_CEILING_HEIGHT_FRACTION = 0.55`; путь к ML-модели фиксирован (`app/ml/models`).

**Сделать:**
- В `app/core/config.py` (или переменные окружения) добавить:
  - `ceiling_height_fraction` (по умолчанию 0.55);
  - `ml_model_dir` (опционально, по умолчанию `app/ml/models`).
- В `scan_processor` и `inference` использовать эти настройки вместо констант.

---

## 4. Качество: порог уверенности для откосов и коробов

**Сейчас:** Все распознанные плоскости с меткой door/window/reveal/frame попадают в ответ.

**Сделать:**
- В конфиг добавить пороги, например:
  - `reveal_min_confidence` (по умолчанию 0.6);
  - `frame_plane_min_confidence` (по умолчанию 0.6).
- В `run_scan_inference` не добавлять в списки `reveals` / `frame_planes` элементы с `confidence` ниже порога (или помечать их как `suggested: true` и отдавать отдельно для «предложений» в UI).

---

## 5. Сводка по коробам

**Сейчас:** В ответе только список плоскостей короба, сумма погонных метров не считается.

**Сделать:**
- В ответ скана добавить поле, например `frame_linear_m_total` — сумма `linear_m` по всем `frame_planes`.
- На Android при подстановке из скана можно сразу подставлять это значение в поле «Короба» (м.п.).

---

## 6. Тесты

**Сделать:**
- Юнит-тесты для `_compute_dimensions`: проверка, что длина/ширина считаются по верхней части облака (например, мок облака с «шумом» внизу).
- Юнит-тесты для `extract_plane_features` и эвристики в `PlaneClassifier` (на фиксированных признаках ожидаемые метки door/window/frame).
- Интеграционный тест: ответ process/finish содержит `reveals` и `frame_planes` с ожидаемой структурой.

---

## 7. Обучение модели

**Сейчас:** Есть скрипт обучения и формат аннотаций; модель можно обучить и положить в `app/ml/models`.

**Сделать:**
- Собрать датасет из реальных сканов (экспорт плоскостей + ручная разметка door/window/reveal/frame).
- Документировать процесс разметки и примеры `*_planes.json` в `app/ml/README.md`.
- Опционально: CI-шаг или скрипт для проверки, что обученная модель загружается и даёт валидные предсказания.

---

## Приоритеты (кратко)

| Приоритет | Доработка |
|-----------|-----------|
| Высокий   | П.1 — показ и подстановка откосов и коробов на Android; П.2 — обновление документации API. |
| Средний   | П.3 — конфиг потолка и ML; П.4 — пороги confidence; П.5 — frame_linear_m_total. |
| Низкий    | П.6 — тесты; П.7 — датасет и обучение. |

Если нужно, можно начать с реализации одного из пунктов (например, парсинг `reveals`/`frame_planes` на Android и подстановка в форму комнаты).

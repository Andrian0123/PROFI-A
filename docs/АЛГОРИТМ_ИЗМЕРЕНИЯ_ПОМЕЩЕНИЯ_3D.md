# Алгоритм измерения помещения (3D фото / видеосканер)

## Назначение

Получение предварительных размеров комнаты по видеосъёмке: высота стен, ширина стен по периметру, примыкания пола и потолка, внутренние вертикальные углы, окна и двери. Результат используется для формирования 3D-проекта и подстановки в смету (площади, периметры).

---

## 1. Открытие камеры и подключение

1. Пользователь нажимает **«Фото 3D»** на экране добавления/редактирования комнаты.
2. В диалоге выбирает **«Создать»** → открывается экран сканирования.
3. Запрашивается разрешение на камеру; при успехе отображается превью.
4. Кнопка **«Подключить»** — подтверждение готовности камеры и переход к режиму сканирования (активация видеопотока для обработки).

**Результат шага:** камера открыта, видеопоток готов к анализу.

---

## 2. Сканирование с ограничениями по зоне съёмки

1. Пользователь нажимает **«Сканировать»**.
2. Съёмка ведётся в заданных пределах:
   - **по высоте:** в пределах **1,5 м от пола** (нижняя зона стен, плинтус, примыкание пола);
   - **по удалению:** не далее **2 м от стены** (участки строительства/ремонта в зоне досягаемости).
3. Участки строительства, подлежащие сканированию, пользователь может **отметить на плане** (схема комнаты): зоны пола, стен, потолка, проёмов. Это задаёт приоритетные области для анализа кадров.
4. Сканирование продолжается до остановки пользователем или автоматически по покрытию ключевых зон (пол, потолок, углы, двери/окна).

**Результат шага:** видеопоток/набор кадров с привязкой к зонам (пол, стены, потолок, проёмы).

---

## 3. Формирование 3D-проекта по видеосканеру

На основе анализа кадров и (при наличии) данных с датчиков (акселерометр, гироскоп, depth при наличии) строится упрощённая 3D-модель помещения:

1. **Примыкание пола** — линии стыка пола со стенами (нижний периметр).
2. **Примыкание потолка** — линии стыка потолка со стенами (верхний периметр).
3. **Внутренние вертикальные углы** — рёбра между смежными стенами (вертикальные линии).
4. **Окна и двери** — прямоугольные проёмы в стенах (распознавание по контрасту, форме, возможно по шаблону).

Из этих элементов выводятся:
- контур пола и потолка в плане;
- высота помещения по вертикальным углам и примыканиям;
- положение и размеры проёмов.

**Результат шага:** 3D-проект (граф плоскостей и рёбер: пол, потолок, стены, углы, проёмы).

---

## 4. Анализ видеосканером и извлечение размеров

1. **Видеосканер** обрабатывает записанный видеопоток (или последовательность кадров):
   - детекция плоскостей (пол, потолок, стены);
   - детекция линий (рёбра, примыкания, контуры проёмов);
   - при наличии — слияние с данными датчика глубины или AR (ARCore и т.п.).
2. Калибровка масштаба — по известному размеру (референсная длина на сцене или ввод пользователем одной длины).
3. Вычисление **предварительных размеров**:
   - **высота стен** — по вертикальным рёбрам и примыканиям пол/потолок;
   - **ширина стен по периметру** — длины отрезков стены между соседними вертикальными углами (или между углом и проёмом, между проёмами);
   - при необходимости: длина/ширина пола, периметр пола/потолка, площади стен с учётом проёмов.

**Результат шага:** предварительные размеры: высота стен (м), длины стен по периметру (м), опционально площади и периметры.

---

## 5. Сохранение и использование в смете

1. Предварительные размеры сохраняются в запись сканa (room_scans) и/или передаются в форму комнаты (длина, ширина, высота, периметр и т.д.).
2. Значения подставляются в блок «Расчёты» на экране комнаты (площадь пола, потолка, стен; при необходимости — периметр).
3. Пользователь может отредактировать размеры вручную после проверки.

---

## Ограничения и допущения

- Точность зависит от качества камеры, освещения и стабильности съёмки.
- Ограничение зоны съёмки (1,5 м от пола, 2 м от стены) уменьшает искажения и фокус на ремонтируемых зонах.
- Отметка участков на плане повышает приоритет нужных зон при неполном скане.
- «Предварительные» размеры требуют проверки пользователем перед использованием в смете.

---

## Связь с экраном приложения

| Шаг алгоритма        | Элемент интерфейса (RoomScanScreen)     |
|----------------------|------------------------------------------|
| Открыть камеру       | Превью камеры после разрешения          |
| Подключить           | Кнопка «Подключить»                      |
| Сканировать          | Кнопка «Сканировать»                     |
| Ограничения 1,5 м / 2 м | Подсказка под кнопками               |
| Участки на плане     | Кнопка/экран «Отметить участки на плане» |
| 3D-проект            | Формируется после анализа (фон)          |
| Видеосканер          | Анализ после остановки сканирования      |
| Предварительные размеры | Блок «Высота стен», «Стены по периметру» (м) |

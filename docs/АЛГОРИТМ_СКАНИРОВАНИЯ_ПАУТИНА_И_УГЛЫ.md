# Алгоритм сканирования: «Паутина» и цветовая визуализация углов примыкания

Доработанная концепция визуальной обратной связи и распознавания геометрии при 3D-сканировании помещения (в духе Polycam, с уникальными элементами для PROFI-A).

---

## 1. Цели и принципы

| Цель | Описание |
|------|----------|
| **Прозрачность** | Пользователь в реальном времени видит, что уже отсканировано и что пропущено. |
| **Цветовая кодировка** | Типы углов (пол–стена, потолок–стена, стена–стена, проёмы) кодируются цветом и иконкой. |
| **Навигация** | Система подсказывает, куда направить камеру (пропущенные зоны, недостающие углы). |
| **Качество** | Метрики покрытия и уверенности распознавания позволяют завершать скан осознанно. |

**Где что реализуется (для PROFI-A):**
- **На устройстве (Android):** превью камеры, оверлей «паутины» и цветных углов, кнопки, проценты покрытия, сохранение размеров в комнату.
- **Обработка 3D/ML:** либо на устройстве (ARCore, ML Kit, собственный легковесный пайплайн), либо на сервере (Python: Open3D, RANSAC, триангуляция Делоне). Обмен сырыми кадрами/глубиной и получение JSON с плоскостями, углами и размерами.

---

## 2. ЧАСТЬ 1: Система «Паутина» (Webbing) — доработки

### 2.1 Идея

- **Покрытие:** 2D-проекция (вид сверху) отсканированных зон; сетка/воксели или триангуляция.
- **«Паутина»:** полупрозрачные линии (например, зелёные пунктирные), соединяющие соседние отсканированные области — визуально «сеть» над планом пола.
- **Пропуски:** зоны без данных подсвечиваются красным (полупрозрачная заливка или контур), опционально с пульсацией.

### 2.2 Доработки к вашему описанию

1. **Источник данных для паутины**
   - Вариант A: только **траектория камеры** (дешёво): строим «паутину» по путям движения (например, Delaunay по 2D-точкам траектории на плане).
   - Вариант B: **облако точек / depth** по кадрам: проекция на плоскость пола → occupancy grid или триангуляция Делоне по 2D-точкам → линии по рёбрам треугольников.
   - Рекомендация: начать с A (траектория + ориентация), затем при наличии depth/point cloud перейти к B для более точного покрытия.

2. **Плотность паутины**
   - Имеет смысл привязать **толщину/прозрачность линий** к локальной плотности данных (больше точек — плотнее/ярче).
   - Альфа (прозрачность) можно ограничить диапазоном 0.15–0.4, чтобы не перекрывать картинку с камеры.

3. **«Пропущенные зоны»**
   - Если геометрия комнаты неизвестна заранее, «дыры» можно определять как **области внутри выпуклой оболочки отсканированных точек, но с плотностью ниже порога** (или по сетке разрешения 0.2–0.5 м).
   - Для прямоугольной комнаты можно задать **ожидаемый контур** (пользователь рисует или выбирает шаблон) и подсвечивать непокрытые части контура.

4. **Производительность на телефоне**
   - Обновлять паутину не каждый кадр, а раз в N кадров или по таймеру (например, 5–10 Гц).
   - Сетку покрытия хранить в фиксированном разрешении (например, 50×50) и пересчитывать только при значительном изменении траектории/точек.

---

## 3. ЧАСТЬ 2: Распознавание углов примыкания — доработки

### 3.1 Типы углов (согласованно с вашей схемой)

| Тип | Описание | Цвет (пример) |
|-----|----------|----------------|
| floor_wall (внутр.) | Пол–стена, внутренний | Ярко-зелёный |
| floor_wall (внеш.) | Пол–стена, внешний | Тёмно-зелёный |
| ceiling_wall (внутр.) | Потолок–стена, внутренний | Оранжевый |
| ceiling_wall (внеш.) | Потолок–стена, внешний | Коричневато-оранжевый |
| wall_wall (внутр.) | Внутренний угол двух стен | Пурпурный |
| wall_wall (внеш.) | Внешний угол двух стен | Тёмно-фиолетовый |
| window_opening | Оконный проём | Голубой |
| door_opening | Дверной проём | Коричневый |
| niche_recess | Ниша/углубление | Желтый |

### 3.2 Доработки к геометрии

1. **Разделение плоскостей**
   - **Пол/потолок:** RANSAC по высоте (Y) — нижняя/верхняя горизонтальная плоскость.
   - **Стены:** вертикальные плоскости (нормаль почти горизонтальна); несколько плоскостей через RANSAC или кластеризацию нормалей.
   - Для Android без depth: можно пробовать **только по RGB** (линии контраста пол–стена, потолок–стена) — менее точно, но не требует depth.

2. **Пересечение плоскостей**
   - Линия пересечения двух плоскостей: направление = cross(n1, n2); точка на прямой — из решения системы двух уравнений плоскостей (псевдообратная матрица или фиксированная высота для вертикальных рёбер).
   - **Внутренний угол стен:** вертикальная прямая (пересечение двух вертикальных плоскостей); ограничиваем её снизу полом, сверху потолком → получаем отрезок «внутренний вертикальный угол».

3. **Проверка «точка в комнате»**
   - Bounding box комнаты можно задать по min/max от всех точек сканa с небольшим запасом; альтернатива — выпуклая оболочка пола в плане.

4. **Уверенность (confidence)**
   - Зависит от: количества inliers RANSAC, согласованности нормалей, расстояния до камеры. Порог 0.6–0.7 для отображения в UI разумен; выше 0.9 — «подтверждённый» угол (сплошная линия, без пульсации).

---

## 4. ЧАСТЬ 3: Цветовая визуализация в интерфейсе — доработки

### 4.1 Отрисовка поверх кадра

- **3D → 2D:** проекция позиции угла (или линии) в экранные координаты через матрицу камеры (intrinsic + extrinsic / pose). На Android это можно делать через CameraX + матрицу проекции.
- **Эффекты:**
  - **scanning:** пульсация (sin(time)*scale для альфа или радиуса), средняя толщина линии.
  - **confirmed:** сплошная линия, без пульсации.
  - **suggested:** пунктир или пульсирующий круг, привлекающий внимание к возможному углу.

### 4.2 Легенда и статистика

- Легенда в углу экрана (как у вас) — только для типов, **реально присутствующих в текущем кадре**, чтобы не загромождать интерфейс.
- Статистика: «Всего углов: N», «Пропущено: M», «Качество: K%». Прогресс-бар можно привязать к доле ожидаемых углов (например, для прямоугольной комнаты без проёмов — 4 внутренних угла стен + 4 линии пол–стена + 4 потолок–стена).

### 4.3 Интеллектуальная подсветка пропусков

- **Предсказание «где должен быть угол»:** для прямоугольной комнаты по уже найденным стенам можно достраивать недостающие вершины прямоугольника в плане и показывать их как «ожидаемые углы» (красный пунктир + текст «Отсканируйте угол»).
- Обобщение на L-образные комнаты: контур по найденным стенам → вершины контура = ожидаемые углы; те, для которых нет близкого обнаруженного junction, — пропущенные.

---

## 5. Интеграция с PROFI-A (Android)

### 5.1 Что уже есть

- Экран сканирования `RoomScanScreen`: камера (CameraX), шаги Подключить → Сканировать → Анализ → Предварительные размеры.
- Передача в комнату: высота стен и периметр по `savedStateHandle` в `AddRoomScreen`.
- Документ алгоритма: `docs/АЛГОРИТМ_ИЗМЕРЕНИЯ_ПОМЕЩЕНИЯ_3D.md`.

### 5.2 Куда встроить «Паутину» и цветовые углы

1. **Оверлей поверх превью камеры**
   - В `RoomScanScreen` поверх `CameraPreviewWithGrid` добавить один или несколько `Canvas` (Compose) или кастомный `View`, которые рисуют:
     - «Паутину» (линии по данным от движка сканирования).
     - Цветные маркеры/линии углов (по списку junctions с 2D-позициями).
     - Красные зоны пропусков (полигоны или круги).
   - Данные для оверлея: либо из ViewModel (состояние: coverage_lines, junctions_2d, missing_zones), либо из нативного слоя (RenderScript/OpenGL), если обработка на устройстве.

2. **Источник данных для оверлея**
   - **Лёгкий вариант (без 3D):** только траектория камеры (гироскоп + акселерометр или визуальная одометрия по кадрам) → 2D-точки на «плане» → паутина по Delaunay (можно считать на устройстве или в фоне).
   - **Полный вариант:** отправка кадров (и при наличии — depth) на сервер; сервер возвращает JSON: `{ "coverage": [...], "junctions": [...], "missing_zones": [...], "dimensions": { "wall_height", "perimeter" } }`. Приложение отображает это на оверлее и подставляет размеры в комнату.

3. **Цветовая схема**
   - Вынести константы цветов (и при желании иконки) в один конфиг (Kotlin `object` или `data class`), синхронизированный с вашей таблицей типов углов. Так легче менять тему и поддерживать единообразие с Python-визуализацией.

4. **Подсказки навигации**
   - Текст внизу экрана (как у вас): «Найдите N пропущенных углов» / «Все углы найдены». Источник — счётчики из того же состояния, что и оверлей.

---

## 6. Сохранение результатов (согласование с вашим save_scan_results)

Предлагаемая структура JSON (для сервера или локального экспорта):

```json
{
  "scan_info": {
    "timestamp": "ISO8601",
    "duration_sec": 120,
    "coverage_percentage": 92
  },
  "junctions": [
    {
      "type": "floor_wall_internal",
      "position_3d": [x, y, z],
      "direction": [dx, dy, dz],
      "confidence": 0.95
    }
  ],
  "dimensions": {
    "wall_height_m": 2.75,
    "perimeter_m": 12.4,
    "floor_area_m2": 18.5
  },
  "quality_metrics": {
    "scan_quality": 0.88,
    "missing_areas": []
  }
}
```

В PROFI-A: при завершении скана сохранять в запись сканa (или в комнату) поля `wall_height_m`, `perimeter_m`, а при наличии — ссылку на файл с полным JSON и/или визуализированной моделью (например, `scan_with_web.ply` или превью).

---

## 7. Этапы внедрения (кратко)

| Этап | Содержание |
|------|------------|
| 1 | Траектория камеры (IMU или визуальная) → 2D-паутина на оверлее в RoomScanScreen, без распознавания углов. |
| 2 | Сервер (или on-device): плоскости RANSAC + пересечения → список junctions; приложение рисует цветные маркеры по 2D-проекциям. |
| 3 | Цветовая схема, легенда, статистика, подсказки «пропущенные углы». |
| 4 | Предсказание пропущенных углов (прямоугольник/L-форма), красная подсветка. |
| 5 | Сохранение dimensions и (опционально) JSON/PLY в скан и подстановка в комнату. |

Так ваши идеи (паутина, цветовые углы, интерактивная обратная связь и навигация) получают чёткую структуру и привязку к текущему приложению, с разделением на «лёгкий старт» и полный пайплайн.

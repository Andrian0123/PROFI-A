# Интеграция сканера помещений

**Ссылка для интеграции (путь в репозитории):**  
`docs/ИНТЕГРАЦИЯ_СКАНЕРА.md`

Подключение сервера сканирования: **`docs/КАК_ПОДКЛЮЧИТЬ_СЕРВЕР_СКАНИРОВАНИЯ.md`**

---

Сканер предназначен для **сканирования помещений и автоматического определения размеров** (высота стен, периметр, площадь пола). Ниже — как устроена интеграция в приложении и обмен данными с сервером.

---

## 1. Назначение

- **Экран сканирования** (`RoomScanScreen`) — пользователь подключает камеру, сканирует помещение или выбирает фото/файл; приложение отправляет данные на сервер и получает **автоматически определённые размеры**: высота стен, периметр, площадь пола.
- Эти размеры можно **применить к комнате** при добавлении/редактировании помещения (`AddRoomScreen`): высота, периметр, площадь подставляются в форму.

---

## 2. Архитектура

| Слой | Компонент | Роль |
|------|-----------|------|
| **UI** | `RoomScanScreen` | Экран: камера, шаги (Подключить → Сканировать → Анализ → Размеры), выбор файла, отображение результатов. |
| **ViewModel** | `RoomScanViewModel` | Сессия скана, вызовы `processScanOnServer` / `finishScanOnServer`, имя проекта. |
| **Локальные данные** | `RoomScanRepository` + `RoomScanDao` + `RoomScanEntity` | Создание/обновление записи скана по проекту и комнате (статус draft/ready, пути к превью/мешу). |
| **Сеть** | `ScanProcessingRepository` + `ScanProcessingApi` | Отправка кадров и траектории на бэкенд, получение размеров. |
| **Применение результатов** | `AddRoomScreen` + `NavController.savedStateHandle` | После «Сохранить» на экране размеров в BackStack передаются `roomScanWallHeight`, `roomScanPerimeter`, `roomScanFloorAreaM2`; экран добавления комнаты подставляет их в поля. |

---

## 3. Алгоритм на экране сканирования

1. **NOT_CONNECTED** → запрос разрешения камеры.
2. **Подключить** → переход в **CONNECTED** (можно сканировать).
3. **Сканировать** — либо:
   - выбор фото/файла (`GetContent`) → файл копируется в кэш (`scan_frames/`), переход в **ANALYZING**;  
   - либо кнопка «Сканировать» → **SCANNING** (визуальная сетка покрытия), затем переход в **ANALYZING** с синтетическим кадром.
4. **ANALYZING**:
   - вызывается `viewModel.processScanOnServer(frameFiles, trajectoryJson)`;
   - при успехе берутся `wallHeightM`, `perimeterM`, `floorAreaM2` из ответа;
   - при неуспехе вызывается `viewModel.finishScanOnServer()` и используются размеры из ответа или заглушки (2,75 м, 12,4 м).
5. **SHOW_DIMENSIONS** — показ карточки с размерами и кнопок «Назад» / «Сохранить».
6. **Сохранить** — `markScanReady()`, запись в `savedStateHandle` предыдущего экрана: `roomScanWallHeight`, `roomScanPerimeter`, `roomScanFloorAreaM2`, затем `popBackStack()`.

---

## 4. API сервера сканирования

Базовый URL задаётся в сборке: **`BuildConfig.SCAN_SERVER_URL`** (см. раздел 6).

### 4.1. Обработка кадров

- **Метод:** `POST {SCAN_SERVER_URL}/api/v1/scan/process`
- **Тип:** `multipart/form-data`
- **Параметры:**  
  `project_id`, `room_id`, `scan_id`,  
  `frames` (один или несколько файлов изображений),  
  опционально: `trajectory` (JSON), `depth` (файлы).

Ответ (JSON) должен содержать, в том числе:

- `dimensions.wall_height_m`, `dimensions.perimeter_m`, `dimensions.floor_area_m2`,  
  а также при необходимости: `length_m`, `width_m`, `ceiling_area_m2`, `wall_area_m2`.
- Могут быть объекты `coverage`, `quality_metrics` (парсятся в `ScanDimensionsResult`).

### 4.2. Завершение сессии

- **Метод:** `POST {SCAN_SERVER_URL}/api/v1/scan/finish`
- **Тип:** `application/json`
- **Тело:** `{ "scan_id", "project_id", "room_id" }`

Используется, когда `process` не вызван или не вернул валидные размеры; сервер может вернуть итоговые размеры по сессии.

---

## 5. Модель данных

- **RoomScanEntity** (таблица `room_scans`): `id`, `projectId`, `roomId`, `createdAt`, `updatedAt`, `thumbnailPath`, `meshPath`, `status` (draft/ready), `title`.
- **ScanDimensionsResult** (ответ API): `scanId`, `lengthM`, `widthM`, `wallHeightM`, `perimeterM`, `floorAreaM2`, `ceilingAreaM2`, `wallAreaM2`, `coveragePercentage`, `scanQuality`.

Размеры с сервера в БД не сохраняются: они передаются только через `savedStateHandle` на экран добавления комнаты и отображаются/подставляются там.

---

## 6. Конфигурация

- **app/build.gradle.kts** — в `defaultConfig` задаётся:
  - `buildConfigField("String", "SCAN_SERVER_URL", "\"\"")`  
  Пустая строка — запросы на сервер не отправляются, используются только локальные/заглушечные размеры.
- Для работы с реальным сервером укажите URL, например:
  - эмулятор: `http://10.0.2.2:8000`;
  - устройство в сети: `http://<IP ПК>:8000`.

Подробнее: **docs/КАК_ПОДКЛЮЧИТЬ_СЕРВЕР_СКАНИРОВАНИЯ.md**.

---

## 7. Связь с добавлением комнаты

- Переход на сканирование: маршрут `room_scan/{projectId}/{roomId}` (из экрана добавления/редактирования комнаты).
- Возврат с результатами: при нажатии «Сохранить» на экране размеров в `previousBackStackEntry.savedStateHandle` кладутся ключи:
  - `roomScanWallHeight` (Double)
  - `roomScanPerimeter` (Double)
  - `roomScanFloorAreaM2` (Double)
- В **AddRoomScreen** в `LaunchedEffect(navController.currentBackStackEntry)` эти значения читаются из `savedStateHandle`, подставляются в поля (высота, периметр по скан‑значению, площадь пола) и ключи удаляются.

---

## 8. Строки и тексты

Локализованные строки для сканера: `scan_title`, `scan_connect`, `scan_scan`, `scan_stop`, `scan_constraints`, `scan_instruction`, `scan_analyzing`, `scan_preliminary_dimensions`, `scan_wall_height`, `scan_wall_width_perimeter`, `scan_no_camera_access`, `scan_server_unavailable_toast`, `scan_pick_file_error`, а также `add_room_scan_perimeter_value` и др. в `values/strings.xml` (и в других локалях).

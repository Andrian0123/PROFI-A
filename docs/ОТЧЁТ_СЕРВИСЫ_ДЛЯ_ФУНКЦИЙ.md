# Отчёт: анализ проекта PROFI-A и сервисы для функций

Краткий разбор функциональности приложения и перечень сервисов, необходимых для работы каждой функции.

---

## 1. Обзор проекта

**PROFI-A** — мобильное приложение (Android, Kotlin, Jetpack Compose) для смет и ремонта: проекты, комнаты, расчёты площадей, подписка, 3D/документ-сканирование.

| Компонент | Технологии | Назначение |
|-----------|------------|------------|
| **Android app** | Kotlin, Compose, Hilt, Room, DataStore, OkHttp, Billing | Клиент: UI, локальные данные, вызовы API |
| **Python Scan Service** | FastAPI, Open3D, RANSAC, ML (опц.) | Обработка сканов помещений и документов |
| **Reference server** | Node.js (server/) | Референсная реализация Auth, Support для разработки |

---

## 2. Функции и нужные им сервисы

### 2.1 Авторизация и аккаунт

**Функции:** вход, регистрация, смена пароля, 2FA, удаление аккаунта.

| Сервис | Назначение | Обязательность |
|--------|------------|----------------|
| **AUTH_SERVER_URL** | Backend API: `POST /auth/login`, `/auth/register`, `/account/change-password`, `/account/2fa`, `/account/delete` | Для продакшена — да. При пустом URL приложение работает в демо-режиме (логин без сети). |

**Контракт:** см. `docs/BACKEND_API_CONTRACTS.md` (раздел 1).

---

### 2.2 Поддержка (обращения пользователей)

**Функции:** форма обращения (телефон, email, описание), отправка тикета.

| Сервис | Назначение | Обязательность |
|--------|------------|----------------|
| **SUPPORT_SERVER_URL** | Backend API: `POST /support/tickets` (phone, email, description) | Желательно. При пустом или недоступном URL — fallback на почтовый клиент (mailto). |

**Контракт:** см. `docs/BACKEND_API_CONTRACTS.md` (раздел 2).

---

### 2.3 Сканирование помещения (путь фото3д)

**Функции:** съёмка кадрами, отправка на сервер, получение размеров (длина, ширина, высота, периметр, площадь пола/потолка/стен, диагональ), покрытие и пропуски, углы примыкания, откосы, короба (м.п.).

| Сервис | Назначение | Обязательность |
|--------|------------|----------------|
| **SCAN_SERVER_URL** | Python-сервис: `POST /api/v1/scan/process`, `POST /api/v1/scan/finish` | Для реальных замеров — да. При пустом URL показываются локальные оценки (заглушки). |
| **Хостинг Python-сервиса** | Uvicorn (FastAPI), порт 8000; для эмулятора: `http://10.0.2.2:8000` | Нужен при использовании сканирования. |
| **Open3D, numpy** | Обработка облака точек, RANSAC, плоскости, junctions | Уже в `requirements.txt`. |
| **Опционально: scikit-learn, joblib** | Обученная модель классификации плоскостей (откосы, короба) | Для улучшения распознавания откосов/коробов. |

**Контракт:** `docs/API_СКАНИРОВАНИЯ_ANDROID_PYTHON.md`.

---

### 2.4 Сканирование документа (путь фото3д)

**Функции:** один снимок документа → ширина/длина (мм), распознавание содержимого (инженерные коммуникации, трубы, кабели, схема и т.д.).

| Сервис | Назначение | Обязательность |
|--------|------------|----------------|
| **SCAN_SERVER_URL** (тот же) | `POST /api/v1/scan/document` — один файл изображения | Тот же хост, что и для скана помещения. |
| **ИИ-модель в document_analyzer** | Распознавание размеров и содержимого (сейчас заглушка) | Для точных размеров и детекции — подключить свою модель в `app/ml/document_analyzer.py`. |

---

### 2.5 Верификация покупок (подписка)

**Функции:** после оплаты через Google Play — отправка данных покупки на сервер для проверки подлинности.

| Сервис | Назначение | Обязательность |
|--------|------------|----------------|
| **VERIFICATION_SERVER_URL** | Backend: `POST /verify` (purchaseToken, productId, orderId) → `valid`, `endDateMillis` | Рекомендуется для продакшена. При пустом URL подписка активируется только по ответу Google Play на устройстве. |
| **Google Play Developer API** | Проверка подписки (purchases.subscriptions) на сервере | Нужен при использовании VERIFICATION_SERVER_URL. |

**Контракт:** `README.md`, `docs/SUBSCRIPTION_BILLING.md`.

---

### 2.6 Подписка и биллинг (клиент)

**Функции:** пробный период, планы 1/6/12 мес., промокоды, покупка через Google Play.

| Сервис | Назначение | Обязательность |
|--------|------------|----------------|
| **Google Play Billing** | Нативная библиотека billing-ktx, Product ID: profi_a_sub_1/6/12 | Да для реальных покупок. При отсутствии GMS — демо-режим. |
| **Google Play Console** | Настройка подписок, ключи | Да для публикации и приёма платежей. |

---

### 2.7 Локальные данные (проекты, комнаты, сметы)

**Функции:** проекты, комнаты, проёмы, виды работ, акты, расчёты — хранение на устройстве.

| Сервис | Назначение | Обязательность |
|--------|------------|----------------|
| **Room Database** | SQLite через Room (проекты, комнаты, проёмы, скан-сессии и т.д.) | Встроено, внешний сервис не нужен. |
| **DataStore** | Настройки, профиль, состояние подписки | Встроено. |

---

### 2.8 Хранение артефактов скана (меш, превью, JSON)

**Функции:** после `scan/finish` в ответе приходят URL меша, превью и JSON (сейчас заглушки cdn.example.com).

| Сервис | Назначение | Обязательность |
|--------|------------|----------------|
| **Хранилище (S3/CDN или свой)** | Реальное сохранение файлов по `scan_id` и выдача URL в `artifacts` | Для персистентного доступа к мешу и превью — реализовать на бэкенде скана или отдельном сервисе. |

---

## 3. Сводная таблица сервисов

| Сервис / URL | Функции | Где задаётся | Примечание |
|--------------|---------|--------------|------------|
| **AUTH_SERVER_URL** | Авторизация, аккаунт | `app/build.gradle.kts` | Пустой → демо-логин. |
| **SUPPORT_SERVER_URL** | Обращения в поддержку | `app/build.gradle.kts` | Пустой → mailto. |
| **SCAN_SERVER_URL** | Скан помещения + скан документа | `app/build.gradle.kts` | Пустой → локальные оценки по скан-экрану. |
| **VERIFICATION_SERVER_URL** | Верификация покупок | `app/build.gradle.kts` | Пустой → активация только по клиенту. |
| **Python Scan Service** | Обработка process/finish/document | Запуск uvicorn, порт 8000 | Тот же хост, что и SCAN_SERVER_URL. |
| **Google Play Billing** | Покупка подписки | Google Play Console | Обязателен для монетизации. |
| **Google Play Developer API** | Проверка подписок на сервере | Сервер верификации | Нужен при VERIFICATION_SERVER_URL. |
| **Хранилище файлов (CDN/S3)** | Артефакты скана (mesh, preview, json) | Реализация на бэкенде | Опционально, для постоянных ссылок. |
| **ИИ-модели (опц.)** | Классификация плоскостей; распознавание документа | app/ml/ (models/, document_analyzer) | Улучшение откосов/коробов и контента документа. |

---

## 4. Минимальный набор для разработки

- **Android:** собрать с пустыми URL (или с `SCAN_SERVER_URL=http://10.0.2.2:8000` для эмулятора).
- **Скан помещений:** запустить Python-сервис: `uvicorn app.main:app --host 0.0.0.0 --port 8000`.
- **Reference server (Node):** при необходимости Auth/Support — `node server/server.js` (порты по конфигу в server/).

---

## 5. Минимальный набор для продакшена

1. **Backend Auth** — реализация или хостинг по контракту AUTH_SERVER_URL.
2. **Backend Support** — реализация POST /support/tickets (SUPPORT_SERVER_URL).
3. **Scan Service** — развёртывание Python-сервиса (SCAN_SERVER_URL), при необходимости — хранилище для артефактов.
4. **Верификация покупок** — сервер с POST /verify и интеграция с Google Play Developer API (VERIFICATION_SERVER_URL).
5. **Google Play Console** — настройка подписок и публикация приложения.

---

Итог: для полной работы функций нужны четыре URL в BuildConfig (Auth, Support, Scan, Verification), хостинг Python Scan Service, Google Play Billing и при продакшене — бэкенд верификации с вызовом Google Play API; остальное (Room, DataStore, локальные оценки, fallback mailto) работает без дополнительных сервисов.

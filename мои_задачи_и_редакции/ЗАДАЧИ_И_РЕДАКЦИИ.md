# Мои задачи и редакции — проект PROFI-A

Документ фиксирует задачи (запросы) и внесённые правки в проект для подтверждения авторства разработки.  
*Запросы, относящиеся к другим приложениям, не учитываются.*

**Полная история переписки** (все запросы и редакции по диалогам) — в файле **[ПОЛНАЯ_ИСТОРИЯ_ПЕРЕПИСКИ.md](ПОЛНАЯ_ИСТОРИЯ_ПЕРЕПИСКИ.md)** в этой же папке.

---

## 1. Заглушки по экранам

**Задача:** Доработать заглушки в трёх местах:
- **RoomScanScreen** — кнопка «Отметить участки на плане»;
- **ChangePasswordScreen** — «Сбросить пароль»;
- **AddWorkTypesScreen** — вкладки «Общие данные» и «Материалы».

**Редакции:** Реализованы Toast/диалог для «Отметить участки на плане», диалог для «Сбросить пароль»; в плейсхолдерах вкладок использован `catalog_placeholder`.

---

## 2. Ошибка сборки в ProjectDetailScreen

**Задача:** Устранить ошибку «Expecting '}'» в `ProjectDetailScreen.kt` (стр. 265–266).

**Редакции:** Добавлена недостающая закрывающая `}` для внешнего `Column`.

---

## 3. Ошибки компиляции (12 ошибок)

**Задача:** Исправить вызовы `@Composable` не из composable-контекста и «Cannot access 'weight': it is internal».

**Редакции:** Удалён импорт `weight` в затронутых файлах; в AddWorkTypesScreen и EditProfileSectionScreen строки для snackbar/кнопки берутся в composable-контексте и передаются в лямбды.

---

## 4. Читаемость скроллов

**Задача:** Убрать полупрозрачность — скроллы и поверхности должны быть непрозрачными.

**Редакции:** В `Color.kt` заданы непрозрачные `Surface` и `SurfaceVariant`; в Theme и ряде экранов добавлен непрозрачный фон для скроллов и карточек.

---

## 5. Адаптация под диагональ экрана

**Задача:** Автоматическая адаптация под разные размеры экрана.

**Редакции:** В `WindowFormFactor.kt` введены Compact/Medium/Expanded и соответствующие отступы/ограничение ширины контента.

---

## 6. Unresolved reference: name (ProjectData)

**Задача:** Ошибка «Unresolved reference: name» в 7 файлах — у `ProjectData` нет поля `name`.

**Редакции:** В модель добавлено свойство `displayName`; во всех местах вместо `project?.name` используется `project?.displayName` (экраны и ViewModel).

---

## 7. Логика в актах — ИП «плюс»

**Задача:** Выбранный процент ИП должен **прибавляться** к сумме в актах и отображаться (например, «С учётом ИП (X%): … ₽»).

**Редакции:** В `EstimateExport.exportActToPdf` и `exportActToCsv` добавлена строка «С учётом ИП (X%): … ₽»; в диалоге акта на ActsScreen отображается та же логика.

---

## 8. Удалить блок привязки фото профиля

**Задача:** Удалить блок «Привязка и отвязка фото профиля» на экране профиля.

**Редакции:** Блок и связанный код (фото, лаунчер) удалены из ProfileScreen.

---

## 9. FormKs2Ks3 — иконка, дата, кнопка, формат

**Задача:** Иконка «глаз» для просмотра промежуточной сметы; убрать дублирование даты/времени; кнопка «Сформировать и поделиться» и выбор формата с подсказкой про отправку.

**Редакции:** Иконка Visibility справа у каждого акта, диалог просмотра `ViewActDialog`, одна строка даты/времени, кнопка «Сформировать и поделиться», диалог выбора формата с текстом про отправку.

---

## 10. Учёт скидки и ИП при формировании акта

**Задача:** При формировании учитывать скидку (минус выбранный % от суммы) и/или ИП (плюс выбранный % к сумме). «Итого по работам» — базовая сумма; при наличии скидки/ИП показывать «Итого к оплате» с учётом процентов.

**Редакции:** В `EstimateExport.kt` в PDF и CSV: строка «Итого по работам», при скидке — «Скидка (Y%):», при ИП — «С учётом ИП (Y%):», при скидке или ИП — «Итого к оплате». Добавлены строки `estimate_discount_label`, `estimate_total_with_tax_label`, `estimate_total_to_pay`, `estimate_total_works_label`. В диалоге акта (ActsScreen) — та же логика и подпись «Итого по работам».

---

## 11. Порядок видов работ по блокам

**Задача:** Порядок видов работ учитывать блоки: первый блок — потолок, второй — стены, третий — пол и т.д.

**Редакции:** В `GeneralEstimateViewModel.kt` введён порядок блоков (Потолок, Стены, Пол, Двери, Окна, Сантехника, Электрика, Вентиляция, Прочие работы). При формировании секций сметы позиции сортируются по блоку, затем по названию работы.

---

## 12. Ошибки сборки (EntityMapper, ensureDefaultCurrencyFromLocale, предупреждения)

**Задача:** Исправить 4 ошибки компиляции и предупреждения по скриншоту сборки.

**Редакции:** В `EntityMapper.kt` убраны параметры `discountText` и `taxPercentText` из маппера в `ProjectData` (в модели их нет). В `PreferencesDataStore` добавлен метод `ensureDefaultCurrencyFromLocale()`, в `PreferencesRepository` — его вызов. В `EstimateExport.kt` убрана избыточная переменная `tableHeaderY`; в ActsScreen заменён устаревший `Locale("ru")` на `Locale.forLanguageTag("ru")` (и для en, de, ro).

---

## 13. Проверка и исправление логики скидки и ИП

**Задача:** Проверить, что ИП — плюс выбранный процент к сумме; «Итого по работам» — базовая сумма; при скидке/ИП показывается «Итого к оплате».

**Редакции:** Обнаружена причина сбоя: для ИП в меню используется строка «НДС 20%», парсер ожидал только число и «%». В `EstimateExport.kt` функция `parsePercent` переписана — процент извлекается по регулярному выражению из строк вида «5%», «НДС 20%». В `ActsScreen.kt` добавлена `parsePercentFromDisplayText` с той же логикой для диалога акта. Логика расчёта (база → скидка минус % → ИП плюс % → итого к оплате) подтверждена и сохранена.

---

*Документ ведётся по мере выполнения задач. Остановка записи — по указанию автора.*

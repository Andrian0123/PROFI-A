# Отчёт выполненных задач — PROFI-A

Только реализованные к данному моменту задачи.

---

## 1. Экран комнаты (AddRoomScreen) — виды работ

| № | Задача | Статус |
|---|--------|--------|
| 1.1 | Иконка «Редактировать» (карандаш) вместо «Удалить» у каждой позиции видов работ; по нажатию данные в форму, кнопка «Сохранить», обновление позиции | Выполнено |
| 1.2 | Начальная единица измерения «кв.м.» по умолчанию в форме видов работ | Выполнено |
| 1.3 | Подстановка количества: «Потолок» — площадь потолка, «Стены» — площадь стен, «Пол» — площадь пола из блока «Расчёты»; после добавления/сохранения снова подставляются «кв.м.» и площадь | Выполнено |
| 1.4 | Разделы видов работ: Потолок, Стены, Пол, Двери, Окна, Сантехника, Электрика, Вентиляция, Прочие работы; в каждом — наименование, ед. изм., цена, кол-во, кнопка «Добавить», список добавленных позиций ниже | Выполнено |
| 1.5 | Шаблоны единиц измерения (п.м., кв.м., шт., м³, т.) — выпадающий список при выборе «Ед. изм.» | Выполнено |
| 1.6 | В разделе «Расчёты» в конце выводится «Общая сумма комнаты» | Выполнено |
| 1.7 | Всплывающий математический калькулятор — кнопка справа в шапке экрана комнаты, открывается SimpleCalculatorDialog | Выполнено |
| 1.8 | На экране редактирования комнаты меню (гамбургер) не показывается | Выполнено |
| 1.9 | Кнопка «Загрузить» в диалоге «Фото 3D»: выбор файла, копирование в папку приложения, сохранение пути в RoomScan (meshPath) | Выполнено |
| 1.10 | Подстановка площади пола из 3D-скана в форму комнаты: RoomScanScreen передаёт roomScanFloorAreaM2 в SavedStateHandle, AddRoomScreen подставляет в поле «Площадь пола»; на экране размеров скана отображается площадь пола (м²) | Выполнено |

---

## 2. Общая смета (GeneralEstimateScreen)

| № | Задача | Статус |
|---|--------|--------|
| 2.1 | Разбивка по помещениям: смета по порядку создания помещений, у каждого — заголовок, список позиций, итог по помещению, общая сумма | Выполнено |
| 2.2 | Кнопка «Поделиться» справа вверху: выбор PDF или Excel (CSV), формирование файла и отправка через «Поделиться» | Выполнено |
| 2.3 | Вверху отображаются название проекта и подпись «Общая предварительная смета помещений по данному проекту» | Выполнено |
| 2.4 | Кнопка «Создать промежуточная смета» слева вверху: режим выбора с кружками, подсветка выбранных карточек, «Отмена» и «Создать»; при «Создать» — сохранение акта с датой/временем в названии | Выполнено |

---

## 3. Акты

| № | Задача | Статус |
|---|--------|--------|
| 3.1 | Экран «Акты» с экрана проекта; список актов по выбранному проекту | Выполнено |
| 3.2 | Просмотр акта: диалог с содержимым по помещениям и итогом | Выполнено |
| 3.3 | В диалоге просмотра акта кнопка «Поделиться» — выбор PDF или Excel, формирование файла и отправка | Выполнено |
| 3.4 | Хранение актов в БД: сущности, DAO, миграция 3→4, методы в ProjectRepository | Выполнено |

---

## 4. Профиль ИП/ООО — КС-2 и КС-3

| № | Задача | Статус |
|---|--------|--------|
| 4.1 | Блок «КС-2 / КС-3» на экране профиля только для типа «ИП / ООО»; кнопка «Сформировать КС-2 / КС-3» | Выполнено |
| 4.2 | Экран формирования: выбор КС-2 или КС-3, проект, акт, формат PDF/Excel; формирование файла с реквизитами профиля и данными акта, отправка | Выполнено |

---

## 5. Экспорт в файлы

| № | Задача | Статус |
|---|--------|--------|
| 5.1 | EstimateExport.kt: экспорт общей сметы и акта в PDF и CSV (по помещениям, с итогами) | Выполнено |
| 5.2 | Ks2Ks3Export.kt: экспорт КС-2 и КС-3 в PDF и CSV | Выполнено |
| 5.3 | FileProvider в манифесте и file_paths.xml для раздачи файлов при «Поделиться» | Выполнено |

---

## 6. Привязка к проекту и интерфейс

| № | Задача | Статус |
|---|--------|--------|
| 6.1 | Подпись на экране проекта: «Комнаты, сметы и акты формируются индивидуально по каждому проекту» | Выполнено |
| 6.2 | На экранах «Предварительная смета» и «Акты» — название проекта и подписи о данных по проекту | Выполнено |
| 6.3 | Нижняя панель с кнопкой «Калькулятор» не отображается в навигации (bottomBar отключён) | Выполнено |

---

## Созданные файлы (связанные с выполненными задачами)

- `ui/export/EstimateExport.kt` — экспорт сметы и акта в PDF/CSV  
- `ui/export/ExportUtils.kt` — утилита экранирования CSV (escapeCsv) для экспорта  
- `ui/export/Ks2Ks3Export.kt` — экспорт КС-2/КС-3 в PDF/CSV  
- `data/local/entity/IntermediateEstimateActEntity.kt`, `IntermediateEstimateActItemEntity.kt`  
- `data/local/dao/IntermediateEstimateActDao.kt`  
- `ui/screens/ActsScreen.kt`, `FormKs2Ks3Screen.kt`  
- `ui/viewmodel/ActsViewModel.kt`, `FormKs2Ks3ViewModel.kt`  
- `res/xml/file_paths.xml`  

## Основные изменённые файлы

- `AddRoomScreen.kt` — виды работ, карандаш, кв.м., подстановка площадей, единицы измерения, общая сумма комнаты, калькулятор  
- `GeneralEstimateScreen.kt`, `GeneralEstimateViewModel.kt` — разбивка по помещениям, «Поделиться», промежуточная смета  
- `ProjectDetailScreen.kt` — переход на «Акты», подпись по проекту  
- `ProjectRepository.kt`, `AppDatabase.kt`, `AppModule.kt` — акты, миграция  
- `NavRoutes.kt`, `ProfiANavHost.kt` — маршруты актов и КС-2/КС-3  
- `ProfileScreen.kt` — блок КС-2/КС-3 для ИП/ООО  
- `AndroidManifest.xml` — FileProvider  

---

## 9. Дополнительно выполнено (серия «далее»)

| Задача | Статус |
|--------|--------|
| Калькулятор справа в шапке на экране «Создание проекта» | Выполнено |
| Калькулятор справа на экране «Виды работы» (AddWorkTypesScreen) | Выполнено |
| Надпись «Проект» над списком карточек на главном экране | Выполнено |
| Общая стоимость проекта внизу экрана проекта | Выполнено |
| Предложение «Добавить этаж» после сохранения комнаты | Выполнено |
| Редактировать/удалить позицию в предварительной смете по троеточию | Выполнено |
| AddWorkTypesScreen: кнопка «+» — диалог; переход по категории — WorkCategoryScreen | Выполнено |
| Room schema: путь для kapt через project.file("schemas").absolutePath | Выполнено |
| ForemanInviteScreen: отправка приглашения по email (mailto) | Выполнено |
| Валидация при экспорте КС-2/КС-3: Toast при пустом профиле/акте | Выполнено |
| Исправление Int/Float в EstimateExport.kt | Выполнено |
| Кнопка «Загрузить» 3D: копирование файла, сохранение пути в RoomScan (meshPath) | Выполнено |
| Ошибка сборки kapt (MissingType AppDatabase): exportSchema = false, убран room.schemaLocation | Выполнено |
| WorkCategoryScreen: справочник видов работ по категориям (Потолок, Стены, Пол и др.), список карточками | Выполнено |
| Калькулятор в навигации: пункт «Калькулятор» в боковом меню (drawer), переход на экран калькулятора | Выполнено (добавлен пункт в drawer и обработка в ProfiANavHost — 20.02.2026) |
| Валидация при экспорте: Toast при ошибке записи файла (PDF/CSV) на экранах сметы, актов и КС-2/КС-3 | Выполнено |
| Экран проекта: две кнопки «Общая смета» и «Сформировать смету» объединены в одну «Предварительная смета» | Выполнено |
| Тесты: ExportUtils.escapeCsv вынесен в объект ExportUtils, добавлены юнит-тесты ExportUtilsTest для экспорта CSV | Выполнено |
| «Площадь можно изменить»: проверено — строка в коде и ресурсах отсутствует, убирать нечего | Выполнено |
| AddWorkTypesScreen «+»: форма добавления шаблона вида работы (наименование, категория, ед. изм., цена), сохранение в DataStore (WorkTemplate), AddWorkTypesViewModel | Выполнено |
| WorkCategoryScreen: кнопка «+» на каждой работе — диалог «Добавить в мои шаблоны», сохранение в шаблоны (WorkCategoryViewModel) для подстановки в комнате | Выполнено |
| Промежуточная смета: выбранные позиции темнее; позиции уже в актах исключены из выбора при создании новой сметы (workItemId в актах, миграция 4→5) | Выполнено |
| Редактирование позиций акта только в разделе «Акты»; на смете для позиций в акте — подпись «Редактировать в разделе Акты»; в акте — кнопка «Редактировать», диалог, перерасчёт и сохранение | Выполнено |
| База 3D-сканера: RoomScan (сущность, DAO, репозиторий), экран RoomScanScreen, кнопки «Фото 3D» → «Создать»/«Загрузить» подключены | Выполнено |
| Подстановка шаблонов в комнате: в AddRoomScreen по разделам (Потолок, Стены и т.д.) показываются «Из шаблонов» — кнопки с названиями; по нажатию подставляются наименование, ед. изм., цена | Выполнено |
| Исправление сборки: добавлена недостающая «}» для блока if (selectionMode) в GeneralEstimateScreen.kt | Выполнено |
| Юнит-тест для позиции акта: IntermediateEstimateActItemEntityTest (расчёт total = price × quantity) | Выполнено |
| Исправление AddWorkTypesScreen: LocalContext.current в onClick (Toast) — контекст читается в теле @Composable, в колбэке используется переменная | Выполнено |
| Юнит-тест actTotalSum_isSumOfItemTotals: проверка расчёта итога по акту как суммы позиций | Выполнено |
| Юнит-тест RoomWorkItemEntityTest: расчёт total (price × quantity) для позиции вида работ в комнате | Выполнено |
| Юнит-тест roomTotalSum_isSumOfItemTotals: итог по комнате как сумма позиций (как в AddRoomScreen) | Выполнено |
| ExportUtils.escapeCsv: учёт символа `\r` в полях CSV + тест escapeCsv_containsCarriageReturn_wrappedInQuotes | Выполнено |
| ExportUtils.escapeCsv: учёт табуляции `\t` в полях CSV + тест escapeCsv_containsTab_wrappedInQuotes | Выполнено |
| Итоговая смета: маршрут final_estimate, кнопка на экране проекта; экран сметы с заголовком «Итоговая смета» и подписью «Итоговая смета по проекту», без кнопки «Создать промежуточная смета» | Выполнено |
| Экспорт сметы: в PDF и CSV передаётся заголовок (Предварительная/Итоговая смета) в зависимости от экрана; в CSV добавлена первая строка с заголовком | Выполнено |
| Экспорт: для итоговой сметы файлы с префиксом itog_smeta_ (PDF/CSV), для предварительной — smeta_ | Выполнено |
| Экран проекта: кнопки сметы/актов в два ряда (Предварительная смета + Акты; Итоговая смета на отдельной строке) | Выполнено |
| Строки сметы вынесены в ресурсы (preliminary_estimate, final_estimate, acts, подзаголовки); экраны и экспорт используют stringResource; добавлены значения в values-en | Выполнено |
| Строки экрана сметы в ресурсы: create, create_intermediate_estimate, select_works_for_intermediate, share_estimate, choose_file_format, export_*_failed, no_works_add_in_rooms, in_act_edit_in_acts; GeneralEstimateScreen переведён на stringResource | Выполнено |
| Строки диалога «Редактировать позицию» в ресурсы: edit_position, item_name, unit_abbr, price_rub, quantity, edit_action, delete_action; меню и кнопки используют stringResource | Выполнено |
| Строки экрана «Акты» в ресурсы: saved_intermediate_estimates, no_acts_create_intermediate, share_act, edit_act_position, close, total_label, price_rub_parens; ActsScreen переведён на stringResource | Выполнено |
| Смета PDF/CSV: в верхней части листа слева — данные заказчика (из проекта), справа — данные исполнителя (из профиля); EstimateExport, GeneralEstimateViewModel, GeneralEstimateScreen | Выполнено |

---

## Дополнение 20.02.2026 (меню и локализация)

| Задача | Статус |
|--------|--------|
| Пункт «Калькулятор» в боковом меню (drawer): добавлен в NavigationDrawer.kt, переход по маршруту `calculator` в ProfiANavHost.kt | Выполнено |
| CreateProjectScreen: contentDescription кнопки калькулятора переведён на stringResource(R.string.content_desc_calculator) | Выполнено |

---

**Проверка файлов:** перечисленные в отчёте созданные и изменённые файлы проверены; недостающих нет.

*Отчёт только по выполненным задачам. Что осталось — см. «ОТЧЁТ_НЕВЫПОЛНЕННЫХ_ЗАДАЧ.md».*
